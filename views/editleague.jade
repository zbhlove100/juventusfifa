extends layout
block content
  link(rel='stylesheet', href='/stylesheets/admindashboard.css')
  script.
    var groupblocktemplate = "<div class='col-sm-2'><button class='btn btn-default' onclick='selectgroup(\"{groupnum1}\")'>"+
                              "{groupnum2} 组</button></div>";
    var leaguenode = {group:[]};
    function isNaN(val) { 
       return val.match(new RegExp("^[0-9]+$"));
    } 
    var dict = ["A","B","C","D","E","F","G","H","I","J","K","L","M","N","O","P","Q","R","S","T","U","V","W","X","Y","Z"]
    function addgroup(){
      //- var gn = isNaN($.trim($("#groupnumber").val()))
      
      //- var sum = 0;
      //- if(gn){
      //-   sum = parseInt(gn);
      //-   $("#grouplistpanel").empty()
      //-   $("#renctgroupname").val(0)
      //-   leaguenode.group = [];
      //- }
      var mark = leaguenode.group.length;
      var gpblock = groupblocktemplate.replace('{groupnum1}',dict[mark]).replace('{groupnum2}',dict[mark]);
      $("#grouplistpanel").append(gpblock)
      var group = {name:dict[mark],members:[]}
      leaguenode.group.push(group)
    }
    var trtemplate = "<tr><td>{no}</td><td>{playername}</td><td>{qq}</td><td>"+
    "<button class='btn btn-warining' onclick='deletethismem(\"{delgno}:{delmno}\")'>-</button></td></tr>";

    function selectgroup(groupnum){
      $("#groupmembers>tbody").empty()
      $("#renctgroup").html(groupnum+"组名单")
      $("#renctgroupname").val(groupnum)
      
      $.each(leaguenode.group,function(index,value){
          if(value.name == groupnum)
            if(value.members){
              $.each(value.members,function(i,v){
              var membertr = trtemplate.replace('{playername}',v.name)
                                        .replace('{qq}',v.qq)
                                        .replace('{no}',i)
                                        .replace('{delgno}',index)
                                        .replace('{delmno}',i)
              $("#groupmembers>tbody").append(membertr);
              })
            }
            
        })
    }
    function deletethismem(no){
      var nos = no.split(":");
      leaguenode.group[nos[0]].members.splice(nos[1],1);
      var groupname = $("#renctgroupname").val()
      selectgroup(groupname)
    }
    var membersnode = []
    //pagination params
    var pagesize = 20;
    var totalmember = 0;
    var loadmembers = function(){
       $.ajax({
          url:"/admin/getplayerlist",
          type:"GET",
          data:{},
          dataType:"json",
          success:function(data){
            membersnode = data;
            totalmember = data.length;
            $("#memberpagination").empty();
            $("#memberpagination").append('<li><a href="#">&laquo;</a></li>');
            var maxpage = (totalmember%pagesize) != 0?totalmember/pagesize+1:totalmember/pagesize
            for(var i=1;i<=maxpage;i++){
              $("#memberpagination").append('<li><a href="javaScript:changememberpage('+i+')">'+i+'</a></li>');
            }
            $("#memberpagination").append('<li><a href="#">&raquo;</a></li>');
            changememberpage(1)
          }
          })
    }

    var playertemplate = "<tr><td><input type='checkbox' name='selectmemeber' value='{playerid}:{index}'></td><td>{playername}</td><td>{qq}</td></tr>";

    function changememberpage(num){
      $("#gourpeditpanel>tbody").empty()
      var from = (num-1)*pagesize + 1;
      var until = num*pagesize>totalmember?totalmember:num*pagesize;
      for(var i=from-1;i<until;i++){
        var value = membersnode[i];
        var template1 = playertemplate.replace('{playerid}',value.id).replace('{index}',i).replace('{playername}',value.name).replace('{qq}',value.qq);
        $("#gourpeditpanel>tbody").append(template1);
      }
      $("#memberpagination>li").removeClass("active");
      $("#memberpagination>li:has(a:contains("+num+"))").addClass("active");
    }
    function addmembertogroup(){
      var groupname = $("#renctgroupname").val()
      if(parseInt(groupname) == 0){
        alert("请选择一下小组!")
      }else{
        $("input[name='selectmemeber']:checked").each(function(i){
          var mixid = $(this).val();
          var ids = mixid.split(":")
          $.each(leaguenode.group,function(index,value){
              if(value.name == groupname){
                console.log(ids[1])
                value.members.push(membersnode[ids[1]]);
              }
            })
          
        })
        
        selectgroup(groupname);
      }
      
    }
    var loadgroup = function(leagueid){
      $.ajax({
          url:"/admin/getgroups?leagueid="+leagueid,
          type:"GET",
          dataType:"json",
          success:function(data){
            leaguenode.group = data;
            $.each(data,function(index,value){
              var gpblock = groupblocktemplate.replace('{groupnum1}',value.name).replace('{groupnum2}',value.name);
              $("#grouplistpanel").append(gpblock)
              })
          }
          })
    }
    $(function(){
      loadmembers()
      })
  .container-fluid
    .row
      include adminsidebar
      .col-sm-9.col-sm-offset-3.col-md-10.col-md-offset-2
        input#leagueid(type="hidden" value="#{leagueid}")
        h1.page-header League Management
        .row
          .col-xs-4
            form#insertplayer.form-horizontal(role="form")
              .form-group
                label.col-sm-2.control-label(for="playername") Name
                .col-sm-10
                  p.form-control-static #{leaguename}
              .form-group
                label.col-sm-2.control-label(for="playerqq") 赛制
                .col-sm-10
                  p.form-control-static 双循环
              .form-group
                label.col-sm-2.control-label(for="playerqq") Groups
                .col-sm-2
                  button.btn.btn-primary(type="button" onclick="addgroup()") ADD
            .row
              p Group list
            #grouplistpanel.row
            .row(style="border-top:1px solid;margin-top:15px;")
              h3#renctgroup
              input#renctgroupname(type="hidden" value="0")
              table.table.table-striped#groupmembers
                thead
                  tr
                    th #
                    th Player name
                    th qq
                tbody

          .col-xs-4.col-xs-offset-1
            table.table.table-striped#gourpeditpanel
              thead
                tr
                  th 
                  th Player name
                  th qq
              tbody
            .col-xs-4.col-xs-offset-4
              button.btn.btn-success(onclick="addmembertogroup()") ADD
            .col-xs-10.col-xs-offset-2
              ul.pagination#memberpagination
      button.btn.btn-success.btn-lg(onclick="createleague()")
              